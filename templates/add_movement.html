{% extends "base.html" %}

{% block content %}
<h1 class="mb-4">Gestion des Mouvements de Stock</h1>

<!-- Movement Type Selection -->
<div class="card mb-4" id="movement-type-step">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Type de Mouvement</h5>
    </div>
    <div class="card-body text-center">
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-primary" id="entry-btn">Entrée Stock</button>
            <button type="button" class="btn btn-outline-primary" id="exit-btn">Sortie Stock</button>
        </div>
    </div>
</div>

<!-- Movement Form -->
<div class="card" id="movement-form-card" style="display:none;">
    <div class="card-body">
        <form method="POST" action="{{ url_for('add_movement') }}" id="movement-form">
            <input type="hidden" id="movement_type" name="movement_type" value="">

            <!-- Common Fields -->
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="product_id" class="form-label">Produit *</label>
                    <select class="form-select" id="product_id" name="product_id" required>
                        <option value="">Sélectionnez un produit</option>
                        {% for product in products %}
                            <option value="{{ product['id'] }}"
                                    data-family="{{ product['family'] }}"
                                    data-category="{{ product['category'] }}">
                                {{ product['name'] }} ({{ product['family'] }} - {{ product['category'] }})
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-6 mb-3">
                    <label for="quantity" class="form-label">Quantité *</label>
                    <input type="number" class="form-control" id="quantity" name="quantity" min="1" required>
                </div>
            </div>

            <!-- Entry Section -->
            <div id="entry-fields">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="entry_customer_id" class="form-label">Client</label>
                        <select class="form-select" id="entry_customer_id" name="customer_id">
                            <option value="">Sélectionnez un client (optionnel)</option>
                            {% for customer in customers %}
                                <option value="{{ customer['id'] }}">{{ customer['name'] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="sub_batch" class="form-label">SOUS LOT *</label>
                        <input type="text" class="form-control" id="sub_batch" name="sub_batch" required placeholder="Format: YYJJJC (ex: 25125P)">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">DPJ</label>
                        <input type="text" class="form-control" id="dpj" name="dpj" readonly>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">N LOT</label>
                        <input type="text" class="form-control" id="batch" name="batch" readonly>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">DLCJ</label>
                        <input type="text" class="form-control" id="best_before" name="best_before" readonly>
                    </div>
                </div>
            </div>

            <!-- Exit Section -->
            <div id="exit-fields" style="display:none;">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="exit_customer_id" class="form-label">Client *</label>
                        <select class="form-select" id="exit_customer_id" name="customer_id" required>
                            <option value="">Sélectionnez un client</option>
                            {% for customer in customers %}
                                <option value="{{ customer['id'] }}">{{ customer['name'] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Sous-Lot</label>
                        <input type="text" class="form-control" id="exit_sub_batch" name="exit_sub_batch" readonly>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-between mt-4">
                <button type="button" id="cancel-btn" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Retour
                </button>
                <button type="submit" class="btn btn-primary" id="submit-btn">
                    <i class="bi bi-check-circle"></i> Valider
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get all elements
    const entryBtn = document.getElementById('entry-btn');
    const exitBtn = document.getElementById('exit-btn');
    const movementTypeStep = document.getElementById('movement-type-step');
    const movementFormCard = document.getElementById('movement-form-card');
    const movementTypeInput = document.getElementById('movement_type');
    const entryFields = document.getElementById('entry-fields');
    const exitFields = document.getElementById('exit-fields');
    const productSelect = document.getElementById('product_id');
    const form = document.getElementById('movement-form');
    const subBatchField = document.getElementById('sub_batch');
    const dpjField = document.getElementById('dpj');
    const batchField = document.getElementById('batch');
    const bestBeforeField = document.getElementById('best_before');

    // Entry button click handler
    entryBtn.addEventListener('click', function() {
        movementTypeInput.value = 'Entry';
        movementTypeStep.style.display = 'none';
        movementFormCard.style.display = 'block';
        entryFields.style.display = 'block';
        exitFields.style.display = 'none';
        
        // Set proper field names and requirements
        document.getElementById('entry_customer_id').name = 'customer_id';
        document.getElementById('exit_customer_id').removeAttribute('name');
        subBatchField.setAttribute('required', 'required');
        document.getElementById('exit_customer_id').removeAttribute('required');
        
        form.reset();
        productSelect.focus();
    });

    // Exit button click handler
    exitBtn.addEventListener('click', function() {
        movementTypeInput.value = 'Exit';
        movementTypeStep.style.display = 'none';
        movementFormCard.style.display = 'block';
        entryFields.style.display = 'none';
        exitFields.style.display = 'block';
        
        // Set proper field names and requirements
        document.getElementById('exit_customer_id').name = 'customer_id';
        document.getElementById('entry_customer_id').removeAttribute('name');
        document.getElementById('exit_customer_id').setAttribute('required', 'required');
        subBatchField.removeAttribute('required');
        
        generateExitSubBatch();
        form.reset();
        productSelect.focus();
    });

    // Cancel button click handler
    document.getElementById('cancel-btn').addEventListener('click', function() {
        movementFormCard.style.display = 'none';
        movementTypeStep.style.display = 'block';
        form.reset();
    });

    // Generate exit sub-batch
    function generateExitSubBatch() {
        const selectedProduct = productSelect.options[productSelect.selectedIndex];
        if (selectedProduct && selectedProduct.value) {
            const productFamily = selectedProduct.dataset.family;
            const productCode = productFamily === 'Poulet' ? 'P' : 'D';
            const now = new Date();
            document.getElementById('exit_sub_batch').value = 
                `SORTIE-${productCode}-${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}`;
        }
    }

    // Sub-batch field change handler (main calculation point)
    subBatchField.addEventListener('input', function() {
        const subBatch = this.value.trim().toUpperCase();
        const selectedProduct = productSelect.options[productSelect.selectedIndex];
        
        if (!selectedProduct || !selectedProduct.value) return;
        
        const productFamily = selectedProduct.dataset.family;
        const productCategory = selectedProduct.dataset.category;

        // Validate sub-batch format (YYJJJC)
        const subBatchRegex = /^(\d{2})(\d{3})([A-Z])$/;
        if (!subBatchRegex.test(subBatch)) {
            return; // Don't proceed if format is invalid
        }

        try {
            const [, yearShort, julianDay, productCode] = subBatch.match(subBatchRegex);
            
            // Validate product code matches product family
            const expectedCode = productFamily === 'Poulet' ? 'P' : 'D';
            if (productCode !== expectedCode) {
                alert(`Code produit incorrect. Attendu: ${expectedCode} pour ${productFamily}`);
                return;
            }

            // Calculate DPJ date from Julian day
            const year = 2000 + parseInt(yearShort);
            const dpjDate = new Date(year, 0, 1);
            dpjDate.setDate(parseInt(julianDay));
            
            // Set DPJ field
            dpjField.value = 
                `${dpjDate.getDate().toString().padStart(2, '0')}/` +
                `${(dpjDate.getMonth() + 1).toString().padStart(2, '0')}/` +
                `${dpjDate.getFullYear()}`;
            
            // Generate batch (YYCWW-WW format)
            const weekNumber = getWeekNumber(dpjDate);
            batchField.value = `${yearShort}${productCode}${weekNumber}-${weekNumber}`;
            
            // Calculate best before date
            let monthsToAdd = 18; // Default
            if (productCategory === 'Abats') monthsToAdd = 9;
            else if (productCategory === 'VSM') monthsToAdd = 12;
            
            const bestBeforeDate = new Date(dpjDate);
            bestBeforeDate.setMonth(bestBeforeDate.getMonth() + monthsToAdd);
            if (bestBeforeDate.getDate() !== dpjDate.getDate()) {
                bestBeforeDate.setDate(0);
            }
            
            bestBeforeField.value = 
                `${bestBeforeDate.getDate().toString().padStart(2, '0')}/` +
                `${(bestBeforeDate.getMonth() + 1).toString().padStart(2, '0')}/` +
                `${bestBeforeDate.getFullYear()}`;
            
        } catch (e) {
            console.error("Error calculating dates:", e);
        }
    });

    // Helper function to get ISO week number
    function getWeekNumber(date) {
        const d = new Date(date);
        d.setHours(0, 0, 0, 0);
        d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7);
        const week1 = new Date(d.getFullYear(), 0, 4);
        return 1 + Math.round(((d - week1) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
    }

    // Product select change handler
    productSelect.addEventListener('change', function() {
        if (movementTypeInput.value === 'Exit') {
            generateExitSubBatch();
        }
        if (subBatchField.value) {
            subBatchField.dispatchEvent(new Event('input'));
        }
    });

    // Form submission handler
    form.addEventListener('submit', function(e) {
        // First validate common required fields
        if (!productSelect.value || !document.getElementById('quantity').value) {
            e.preventDefault();
            alert('Veuillez sélectionner un produit et entrer une quantité');
            return;
        }

        // Then validate specific fields based on movement type
        if (movementTypeInput.value === 'Entry') {
            const subBatchValue = subBatchField.value.trim();
            const subBatchRegex = /^(\d{2})(\d{3})([A-Z])$/;
            if (!subBatchRegex.test(subBatchValue)) {
                e.preventDefault();
                alert('Format sous-lot invalide. Utilisez le format YYJJJC (ex: 25125P)');
                subBatchField.focus();
                return;
            }
            
            // For entries, use the entry customer field
            document.getElementById('entry_customer_id').name = 'customer_id';
            document.getElementById('exit_customer_id').removeAttribute('name');
        } else if (movementTypeInput.value === 'Exit') {
            if (!document.getElementById('exit_customer_id').value) {
                e.preventDefault();
                alert('Veuillez sélectionner un client pour les sorties de stock');
                document.getElementById('exit_customer_id').focus();
                return;
            }
            
            // For exits, use the exit customer field
            document.getElementById('exit_customer_id').name = 'customer_id';
            document.getElementById('entry_customer_id').removeAttribute('name');
        }
    });
});
</script>

<style>
    .invalid-feedback {
        color: #dc3545;
        font-size: 0.8rem;
    }
    .is-invalid {
        border-color: #dc3545 !important;
    }
    .btn-group .btn {
        width: 200px;
        height: 60px;
        font-size: 1.1rem;
    }
    .form-control[readonly] {
        background-color: #f8f9fa;
    }
</style>
{% endblock %}